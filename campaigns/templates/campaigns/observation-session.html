<!doctype html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="UTF-8">
		<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="Description" content="Job board html template">
		<meta name="Author" content="Spruko Technologies Private Limited">
		<meta name="keywords" content="bootstrap job board template, bootstrap job template, hr consultancy website template, job board bootstrap template, job board html template, job listing html template, job portal html template, job portal templates html5, job posting website template, job recruitment website template, job template bootstrap, job template html, simple html and css templates, simple html css templates, directory listing html template, classified website template, responsive css template, html5 responsive template, job posting template, simple bootstrap template, bootstrap 4 templates, job application template, html5 template, premium, recruitment, template, html, job alert, directory"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="HandheldFriendly" content="True">
		<meta name="MobileOptimized" content="320">
		<link rel="icon" href="favicon.ico" type="image/x-icon"/>
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>

		<!-- Title -->
		<title>POP Ghana | Observation session</title>

		<!-- Bootstrap Css -->
		<link href="/static/plugins/bootstrap-4.3.1-dist/css/bootstrap.min.css" rel="stylesheet" />

		<!-- Dashboard Css -->
		<link href="/static/css/style.css" rel="stylesheet" />

		<!-- Font-awesome  Css -->
		<link href="/static/css/icons.css" rel="stylesheet"/>

		<!--Horizontal Menu-->
		<link href="/static/plugins/horizontal/horizontal-menu/animation/fade-down.css" rel="stylesheet" />
		<link href="/static/plugins/horizontal/horizontal-menu/horizontal.css" rel="stylesheet" />

		<!--Select2 Plugin -->
		<link href="/static/plugins/select2/select2.min.css" rel="stylesheet" />

		<!-- Cookie css -->
		<link href="/static/plugins/cookie/cookie.css" rel="stylesheet">

		<!-- Custom scroll bar css-->
		<link href="/static/plugins/scroll-bar/jquery.mCustomScrollbar.css" rel="stylesheet" />

		<!-- COLOR-SKINS -->
		<link id="theme" rel="stylesheet" type="text/css" media="all" href="/static/color-skins/color-skins/color10.css" />

	</head>
	<body>

		<!--Loader-->
		<div id="global-loader">
			<img src="/static/images/loader.svg" class="loader-img" alt="">
		</div>



		<!--Breadcrumb-->
		<section>
			<div class="bannerimg cover-image bg-background3" data-image-src="/static/images/banners/banner2.jpg">
				<div class="header-text mb-0">
					<div class="text-center text-white">
						<h1 class="">Observation Sessions</h1>
						<ol class="breadcrumb text-center">
							<li class="breadcrumb-item"><a href="/">Home</a></li>
							<li class="breadcrumb-item"><a href="/">Campaign List</a></li>
							<li class="breadcrumb-item active text-white" aria-current="page">Observation sessions</li>
						</ol>
					</div>
				</div>
			</div>
		</section>
		<!--/Breadcrumb-->

		<!--User Dashboard-->
		<section class="sptb">
			<div class="container">
				<div class="row">
					<div class="col-xl-9 col-lg-12 col-md-12">
						<div class="card mb-0">
							<div class="card-header">
								<h3 class="card-title">Sessions</h3>
							</div>
							<div class="card-body">
								<div class="ads-tabs">
									<div class="tabs-menus">
										<!-- Tabs -->
										<ul class="nav panel-tabs">
											<button style="margin:5px" type="button" class="btn btn-warning mr-auto"><a class="text-white" href="/campaigns/new-session" ><i class="fa fa-signing"></i>New Session</a></button>
											<button style="margin:5px" id="contbut" type="button" class="btn btn-success mr-auto"><a class="text-white" href="/campaigns/new-basket" ><i class="fa fa-plus"></i>Continue Current Session</a></button>
											<button style="margin:5px" type="button" class="btn btn-success"><a class="text-white" href="/campaigns/lockscreen" ><i class="fa fa-share"></i>Lock Out</a></button>
										</ul>
									</div>
									<div class="tab-content">
										<div class="tab-pane active table-responsive border-top userprof-tab" id="tab1">
											<table class="table table-bordered table-hover mb-0 text-nowrap">
												<thead>
													<tr>
														<th></th>
														<th class="w-100">Session Name</th>
														<th>Date Started</th>
														<th>Date Finished</th>
														<th>Baskets</th>
														<th>Status</th>
														<th >Action</th>
													</tr>
												</thead>
												<tbody id="alltab"></tbody>
											</table>
										</div>
										<div class="tab-pane  table-responsive border-top userprof-tab" id="tab2">
											<table class="table table-bordered table-hover mb-0 text-nowrap">
												<thead>
													<tr>
														<th></th>
														<th class="w-100">Session Name</th>
														<th>Date Started</th>
														<th>Date Finished</th>
														<th>Baskets</th>
														<th>Status</th>
														<th >Action</th>
													</tr>
												</thead>
												<tbody id="transtab"></tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>



		<!-- Back to top -->
		<a href="#top" id="back-to-top" ><i class="fa fa-arrow-up"></i></a>

		<!-- JQuery js-->
		<script src="/static/js/vendors/jquery-3.2.1.min.js"></script>

		<!-- Bootstrap js -->
		<script src="/static/plugins/bootstrap-4.3.1-dist/js/popper.min.js"></script>
		<script src="/static/plugins/bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>

		<script src="/static/js/dexie.js"></script>
        <script src="/static/js/axios.min.js"></script>
        <script src="/static/js/sweetalert2@8.js"></script>


		<!--JQuery Sparkline Js-->
		<script src="/static/js/vendors/jquery.sparkline.min.js"></script>

		<!-- Circle Progress Js-->
		<script src="/static/js/vendors/circle-progress.min.js"></script>

		<!-- Star Rating Js-->
		<script src="/static/plugins/rating/jquery.rating-stars.js"></script>

		<!--Owl Carousel js -->
		<script src="/static/plugins/owl-carousel/owl.carousel.js"></script>

		<!--Horizontal Menu-->
		<script src="/static/plugins/horizontal/horizontal-menu/horizontal.js"></script>

		<!--JQuery TouchSwipe js-->
		<script src="/static/js/jquery.touchSwipe.min.js"></script>

		<!--Select2 js -->
		<script src="/static/plugins/select2/select2.full.min.js"></script>
		<script src="/static/js/select2.js"></script>

		<!-- Cookie js -->
		<script src="/static/plugins/cookie/jquery.ihavecookies.js"></script>
		<script src="/static/plugins/cookie/cookie.js"></script>

		<!-- Count Down-->
		<script src="/static/plugins/count-down/jquery.lwtCountdown-1.0.js"></script>

		<!-- Custom scroll bar Js-->
		<script src="/static/plugins/scroll-bar/jquery.mCustomScrollbar.concat.min.js"></script>

		<script src="/static/js/campaign.js"></script>

		<!-- sticky Js-->
		<script src="/static/js/sticky.js"></script>

		<!-- Scripts Js-->
		<script src="/static/js/scripts2.js"></script>

		<!-- Custom Js-->
		<script src="/static/js/custom.js"></script>

		<script>
		if (localStorage.getItem('currsession')==null){
		    $('#contbut').hide()
		}
			db.sessions.each(session => {


				var sessions = `<tr>
														<td>
															<label class="custom-control custom-checkbox">
																<input type="checkbox" class="custom-control-input" name="checkbox" value="checkbox">
																<span class="custom-control-label"></span>
															</label>
														</td>
														<td>
															<div class="media mt-0 mb-0">
																<div class="media-body">
																	<div class="card-item-desc p-0">
																		<a href="#" class="text-dark"><h4 class="font-weight-semibold">`+session.session_name+`</h4></a>
																	</div>
																</div>
															</div>
														</td>
														<td><i class ="fa fa-clock-o mr-1 text-muted"></i>`+session.date_started+`</td>
														<td><i class ="fa fa-clock-o mr-1 text-muted"></i>`+session.date_finished+`</td>
														<td class="font-weight-semibold fs-16">`+session.basket_count+`</td>
														<td>
															<a href="#" class="badge badge-warning">`+session.status+`</a>
														</td>
														<td>
															<button id="`+session.session_name+`edbtn" class="btn btn-success btn-sm text-white" data-toggle="tooltip" onclick="editSess('`+session.session_name+`')" data-original-title="Edit"><i class="fa fa-pencil"></i></button>
															<button id="`+session.session_name+`mittbtn" class="btn btn-primary btn-sm text-white" data-toggle="tooltip" onclick="mitt('`+session.session_name+`')" data-original-title="Transmit"><i class="fa fa-wifi"></i></button>
														</td>
													</tr>`
													document.getElementById("alltab").innerHTML +=sessions

			});


function editSess(session_name) {
    localStorage.setItem('editItem',session_name)
    window.location.href="/campaigns/edit-session/"
}

window.onload = function() {

    // window.mit = localStorage.getItem("mittSessame")
    db.sessions.each(mit => {
        if (mit.status=="Transmitted") {
            $('#'+mit.session_name+'mittbtn').hide()
            $('#'+mit.session_name+'edbtn').hide()
        } else if (mit.date_finished=="Not Finished"){
        console.log("Hiding button with id " +'#'+mit.session_name+'mittbtn')
        $('#'+mit.session_name+'mittbtn').hide()
        }else{
            console.log("Hiding button with id " +'#'+mit.session_name+'edbtn')
        $('#'+mit.session_name+'edbtn').hide()
        }
    })


    db.sessions.where('session_name').equals(localStorage.getItem("currsession")).each(ket => {
        if(ket.date_finished =="Not Finished"){
        var btnid = localStorage.getItem("currsession")
        $('#'+btnid+'mittbtn').hide()
        }
        else{
            $('#contbut').hide()
        }
    });
    if (localStorage.getItem('currsession')==null){
		    $('#contbut').hide()
		}
  }




function mitt(session_name){
    Swal.fire({
                  title: 'Transmitting!',
                  allowOutsideClick: false,
                  onBeforeOpen: () => {
                    Swal.showLoading()
                  },
                })
    window.msess = session_name
    localStorage.setItem("mittSessame", session_name)
    console.log(localStorage.getItem('crepharm'))
    if (localStorage.getItem('crepharm') !== null){

    let pharmid = parseInt(localStorage.getItem('pharm_id'))
    var campid = parseInt(localStorage.getItem("campaignId"))
    var usid = JSON.parse(localStorage.getItem("user")).id
    let cresess = {"name":localStorage.getItem("mittSessame"),"campaign":campid,"pharmacy":pharmid,"user":parseInt(usid)}
    console.log(cresess)
    axios.post('/api/v1/campaigns/create-session/', cresess)
    .then(function(response){
                    localStorage.setItem("session_id", parseInt(response.data))
                    console.log("Got session ID " + response.data)

                    db.sessions.get(session_name,function (session){
                    var baskets = session.baskIds;
                    db.baskets.reverse().limit(baskets.length).each((db_basket) => {
                        console.table(db_basket)
                    //create basket at the back
                    var sessid = localStorage.getItem("session_id")
                          axios.post('/api/v1/campaigns/create-basket/', {"session":sessid})
                          .then(function (response) {
                              localStorage.setItem("backskid",parseInt(response.data))

                        let cskid = localStorage.getItem('backskid')
                        console.log("setting up basket "+ cskid +" for transmission")
                        for (let i = 0; i < db_basket.basket.drugs.length; i++) {
                          db_basket.basket.drugs[i].basket = parseInt(response.data);
                          db_basket.basket.drugs[i].leaked = db_basket.basket.drugs[i].leaked.length==3
                          db_basket.basket.drugs[i].switched = db_basket.basket.drugs[i].switched.length==3
                          db.baskets.put(db_basket);
                          window.drugs= db_basket.basket.drugs
                            }
                    window.doned=db_basket
                    let skid = localStorage.getItem('backskid')
                    let patient = {"basket":parseInt(skid),"insurance_scheme":db_basket.basket.insurance,"age":db_basket.basket.Age,"gender":db_basket.basket.Gender}
                //   console.log(patient)

                //   console.log(patient.basket)
                  axios.post('/api/v1/campaigns/create-patient/', patient)
                  .then(function (response) {
                    for (let i = 0; i < window.drugs.length; i++) {
                          window.drugs[i].basket = patient.basket
                      }
                      console.table(db_basket.basket.drugs)
                    axios.post('/api/v1/campaigns/create-drug/', {"drugs":db_basket.basket.drugs})
                  .then(function (response) {
                    //   console.log(response)
                    db_basket.status = 'Transmitted';
                    db.baskets.put(db_basket);

                  })

                  .catch(function(error){
                Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Drugs.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })

                  })
                  .catch(function(error){
                Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Patient.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })




                          })
                          .catch(function(error){
                              console.log(error)
                            Swal.fire({
                                  type: 'error',
                                  title: 'Transmission Failed',
                                  text: 'Error while creating Basket.',
                                //   footer: '<a href>Code[1062] Contact support.</a>'
                                })
                })

                    });
db.ubrands.each(brand_item => {
    console.log(brand_item.things)
   axios.post('/api/v1/campaigns/create-drug-reference/', brand_item.things)
        .then(function (response) {
            console.log(response.data)
            if(typeof response.data == 'number'){
            console.log(response.data)
            // $('body')
            //     .toast({
            //         title: 'Success',
            //         message: 'Reference added',
            //         class: 'orange',
            //         className: {
            //             toast:'ui big message'
            //         }
            //     });


            } else{
                console.log(response.data)
                // $('body')
                //   .toast({
                //     class: 'error',
                //     position: 'top left',
                //     displayTime: 'auto',
                //     message: `We could not add, Please Try again`
                //   });
            }
})
  .catch(function (error) {
    if (exists(error.response)){
              console.log(error.response.data);
            //   db.caremessage.clear();
            //   toaster("There was an error",2000)
          }
  });
})
db.uinns.each(inn_item => {
   axios.post('/api/v1/campaigns/create-inn/', inn_item.things)
        .then(function (response) {
            console.log(response.data)
            if(typeof response.data == 'number'){
            console.log(response.data)
            // $('body')
            //     .toast({
            //         title: 'Success',
            //         message: 'Reference added',
            //         class: 'orange',
            //         className: {
            //             toast:'ui big message'
            //         }
            //     });


            } else{
                console.log(response.data)
                // $('body')
                //   .toast({
                //     class: 'error',
                //     position: 'top left',
                //     displayTime: 'auto',
                //     message: `We could not add, Please Try again`
                //   });
            }
})
  .catch(function (error) {
    if (exists(error.response)){
              console.log(error.response.data);
            //   db.caremessage.clear();
            //   toaster("There was an error",2000)
          }
  });
})

                console.log("done")
                    Swal.fire(
                      'Done!',
                      'Successfully Transmitted!',
                      'success'
                    )
                    fetchCampaigns()
                    let mittSessame = localStorage.getItem("mittSessame")
                    console.log(mittSessame)
                    db.sessions.where('session_name').equals(mittSessame).modify({status: "Transmitted"})
                    db.baskets.clear();
                    $('#'+window.msess+'mittbtn').hide()
                    $('#'+window.msess+'edbtn').hide()

})

    })
    .catch(function(error){
        Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Session.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })

    }
    else {
    var ma = localStorage.getItem("pharmacy_name")
    db.pharmacies.get(ma, function (info) {
        console.log(info);
axios.post('/api/v1/campaigns/create-pharmacy/', info.pharmacy_info)
.then(function (response) {
    if(typeof response.data == 'number'){
    let pharmid = parseInt(response.data)
    var campid = parseInt(localStorage.getItem("campaignId"))
    localStorage.setItem("pharm_id", pharmid)
    localStorage.setItem('crepharm', true)
    var usid = JSON.parse(localStorage.getItem("user")).id
    let crepharm = {"name":localStorage.getItem("mittSessame"),"campaign":campid,"pharmacy":pharmid,"user":parseInt(usid)}
    console.log(crepharm)
    axios.post('/api/v1/campaigns/create-session/', crepharm )
    .then(function(response){
                    localStorage.setItem("session_id", parseInt(response.data))
                    console.log("Got session ID " + response.data)

                    db.sessions.get(session_name,function (session){
                    var baskets = session.baskIds;
                    db.baskets.reverse().limit(baskets.length).each((db_basket) => {
                        console.table(db_basket)
                    //create basket at the back
                    var sessid = localStorage.getItem("session_id")
                          axios.post('/api/v1/campaigns/create-basket/', {"session":sessid})
                          .then(function (response) {
                              localStorage.setItem("backskid",parseInt(response.data))

                        let cskid = localStorage.getItem('backskid')
                        console.log("setting up basket "+ cskid +" for transmission")
                        for (let i = 0; i < db_basket.basket.drugs.length; i++) {
                          db_basket.basket.drugs[i].basket = parseInt(response.data);
                          db_basket.basket.drugs[i].leaked = db_basket.basket.drugs[i].leaked.length==3
                          db_basket.basket.drugs[i].switched = db_basket.basket.drugs[i].switched.length==3
                          db.baskets.put(db_basket);
                          window.drugs= db_basket.basket.drugs
                            }
                    window.doned=db_basket
                    let skid = localStorage.getItem('backskid')
                    let patient = {"basket":parseInt(skid),"insurance_scheme":db_basket.basket.insurance,"age":db_basket.basket.Age,"gender":db_basket.basket.Gender}
                //   console.log(patient)

                //   console.log(patient.basket)
                  axios.post('/api/v1/campaigns/create-patient/', patient)
                  .then(function (response) {
                    for (let i = 0; i < window.drugs.length; i++) {
                          window.drugs[i].basket = patient.basket
                      }
                      console.table(db_basket.basket.drugs)
                    axios.post('/api/v1/campaigns/create-drug/', {"drugs":db_basket.basket.drugs})
                  .then(function (response) {
                    //   console.log(response)
                    db_basket.status = 'Transmitted';
                    db.baskets.put(db_basket);
                  })

                  .catch(function(error){
                Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Drugs.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })

                  })
                  .catch(function(error){
                Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Patient.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })




                          })
                          .catch(function(error){
                              console.log(error)
                            Swal.fire({
                                  type: 'error',
                                  title: 'Transmission Failed',
                                  text: 'Error while creating Basket.',
                                //   footer: '<a href>Code[1062] Contact support.</a>'
                                })
                })

                    });

//                     for (var a = 0; a < baskets.length; a++) {
//                         sender(baskets[a]);
//                         function sender(basket_id){
//                     console.log(basket_id);
//                     window.mittSess = basket_id;

//                         }

// }
db.ubrands.each(brand_item => {
    console.log(brand_item.things)
   axios.post('/api/v1/campaigns/create-drug-reference/', brand_item.things)
        .then(function (response) {
            console.log(response.data)
            if(typeof response.data == 'number'){
            console.log(response.data)
            // $('body')
            //     .toast({
            //         title: 'Success',
            //         message: 'Reference added',
            //         class: 'orange',
            //         className: {
            //             toast:'ui big message'
            //         }
            //     });


            } else{
                console.log(response.data)
                // $('body')
                //   .toast({
                //     class: 'error',
                //     position: 'top left',
                //     displayTime: 'auto',
                //     message: `We could not add, Please Try again`
                //   });
            }
})
  .catch(function (error) {
    if (exists(error.response)){
              console.log(error.response.data);
            //   db.caremessage.clear();
            //   toaster("There was an error",2000)
          }
  });
})
db.uinns.each(inn_item => {
   axios.post('/api/v1/campaigns/create-inn/', inn_item.things)
        .then(function (response) {
            console.log(response.data)
            if(typeof response.data == 'number'){
            console.log(response.data)
            // $('body')
            //     .toast({
            //         title: 'Success',
            //         message: 'Reference added',
            //         class: 'orange',
            //         className: {
            //             toast:'ui big message'
            //         }
            //     });


            } else{
                console.log(response.data)
                // $('body')
                //   .toast({
                //     class: 'error',
                //     position: 'top left',
                //     displayTime: 'auto',
                //     message: `We could not add, Please Try again`
                //   });
            }
})
  .catch(function (error) {
    if (exists(error.response)){
              console.log(error.response.data);
            //   db.caremessage.clear();
            //   toaster("There was an error",2000)
          }
  });
})
                console.log("done")
                    Swal.fire(
                      'Done!',
                      'Successfully Transmitted!',
                      'success'
                    )
                    fetchCampaigns()
                    let mittSessame = localStorage.getItem("mittSessame")
                    console.log(mittSessame)
                    db.sessions.where('session_name').equals(mittSessame).modify({status: "Transmitted"})
                    db.baskets.clear();
                    $('#'+window.msess+'mittbtn').hide()
                    $('#'+window.msess+'edbtn').hide()

})

    })
    .catch(function(error){
        Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Error while creating Session.',
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })
    })
} else{

    Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: "Couldn't create Pharmacy, Problem with submitted data.",
                    //   footer: '<a href>Code[1062] Contact support.</a>'
                    })

                    console.log(response.data)
}

})

.catch(function (error) {
                      Swal.fire({
                      type: 'error',
                      title: 'Transmission Failed',
                      text: 'Please check your internet connection.',
                    //   footer: '<a href>Contact support.</a>'
                    })
                    console.log(error);

                  });



    })

}

}


		</script>
		<script src="/static/js/login.js"></script>
	</body>
</html>
